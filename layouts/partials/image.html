{{ $placeholder := "images/placeholder.png" }}
{{ $params := (dict "lazy" true "sizes" (dict) "class" "" "alt" "" "title" "") }}
{{ $params = merge $params . }}

{{ $width := "" }}
{{ $height := "" }}
{{ $sizes := ""}}

{{ if $params.size }}
{{ $size := split .size "x" }}
{{ $width = index $size 0 }}
{{ $height = index $size 1 }}
{{ end }}

{{ $srcset := "" }}
{{ $src := "" }}

{{ if $params.static }}
{{ $src = $params.src | relURL }}
{{ else }}
{{ $orig := $params.page.Resources.GetMatch $params.src }}

{{ if eq $width "" }}
{{ $width = $orig.Width }}
{{ end }}

{{ if eq $height "" }}
{{ $height = $orig.Height }}
{{ end }}

{{ if $params.size }}
{{ $src = ($orig.Resize (printf "%sx" $width)).RelPermalink }}
{{ else }}
{{ $src = $orig.RelPermalink }}
{{ end }}

{{ $index := 0 }}

{{ range $params.sizes }}
{{ $w := index (split . "x") 0 }}
{{ if eq $index 0 }}
{{ $srcset = printf "%s %sw" ($orig.Resize (printf "%sx" $w)).RelPermalink $w }}
{{ else }}
{{ $srcset = printf "%s, %s %sw" $srcset ($orig.Resize (printf "%sx" $w)).RelPermalink $w }}
{{ end }}
{{ $index = add $index 1 }}
{{ end }}
{{ end }}

{{ $width = printf `width="%spx"` $width | safeHTMLAttr }}
{{ $height = printf `height="%spx"` $height | safeHTMLAttr }}

{{ with $params }}
{{ if .lazy }}
<img src="{{ $placeholder | relURL }}" alt="{{ .alt }}" class="lazy {{ .class }}" data-src="{{ $src }}" data-srcset="{{ $srcset }}" title="{{ with $params.title }}{{ . }}{{ end }}" {{ with $width }}{{ . }}{{ end }} {{ with $height }}{{ . }}{{ end }}>
{{ else }}
<img src="{{ $src }}" alt="{{ .alt }}" class="{{ .class }}" srcset="{{ $srcset }}" title="{{ with $params.title }}{{ . }}{{ end }}" {{ with $width }}{{ . }}{{ end }} {{ with $height }}{{ . }}{{ end }}>
{{ end }}
<noscript>
  <img src="{{ $src }}" alt="{{ .alt }}" class="{{ .class }}" srcset="{{ $srcset }}">
</noscript>
{{ end }}
